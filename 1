/* main.c - Test the PTY */
#include "fever.h"
#include <stdio.h>
#include <unistd.h>
#include <sys/select.h>
#include <signal.h> // a2

int main() {
    /* STEP 1: Initialize PTY */
    int fd = term_init();
    if (fd < 0) return 1;
    
    printf("PTY created. FD=%d\n", fd);
    printf("Shell ready. Commands won't echo here.\n"); // a2
    printf("Type 'exit' or press Ctrl+D to quit.\n"); // a2
    
    /* STEP 2: Simple I/O loop */
    fd_set fds;
    char buf[256];
    int running = 1; // a2
    
    while (running) { // a2
        FD_ZERO(&fds);
        FD_SET(STDIN_FILENO, &fds);  /* Keyboard */
        FD_SET(fd, &fds);            /* Shell output */
        
        /* Wait for activity */
        select(fd+1, &fds, NULL, NULL, NULL);
        
        /* Keyboard -> Shell */
        if (FD_ISSET(STDIN_FILENO, &fds)) {
            int n = read(STDIN_FILENO, buf, sizeof(buf));
            /* if (n > 0) term_write(fd, buf, n); */ // a2
            if(n > 0) { //a2
                 /* Check for Ctrl+D (EOF) */
                if (n == 1 && buf[0] == 4) {
                    term_write(fd, "exit\n", 5);
                    running = 0;
                } else {
                    term_write(fd, buf, n);
                }               
            }else if (n == 0) {
                running = 0;  /* EOF */
            } // a2
        }
        
        /* Shell -> Screen */
        if (FD_ISSET(fd, &fds)) {
            int n = term_read(fd, buf, sizeof(buf));
            /* if (n > 0) write(STDOUT_FILENO, buf, n); */ // a2

            if(n > 0) { // a2
                write(STDOUT_FILENO, buf, n);
            } else if (n == 0) {
                running = 0; // shell closed
            } // a2

        }
    }
    
    /* close(fd); */ // a2
    term_cleanup(fd);
    printf("\n fever closed \n");

    return 0;
}
